---
title: "Basic Model formulation"
author: "Florian D. Schneider"
date: "Tuesday, November 18, 2014"
output:
  html_document:
    keep_md: yes
  pdf_document:
    fig_height: 3.5
    fig_width: 4
fontsize: 12pt
geometry: margin=1.4in
csl: ../manuscript/amnat.csl
bibliography: ../manuscript/cas02.bib
---

This document is supposed to develop a model representation of the global mean field as well as pair-approximations of local feed back mechanisms. 

The default form of the differential equation describing vegetation cover is 

$$ \frac{dV}{dt} = G(V) - C(V)g $$

with growth function $G$ and a function $C$ which represents consumption by a herbivore multiplied by the density of herbivores, the livestock rate, $g$. Formally, intrinsic mortality could be included in both terms. In the formulations of @noy-meir75 and @vandekoppel97 it is assumed to be covered by the logistic growth function.

It might become important in the pair-approximation model, where intrinsic plant mortality is included as a proportional loss of mature plants.

```{r, echo=FALSE}
# Default plotting function

defplot <- function(...) plot(..., 
            type = "l", 
            bty = "l", cex = 0.7, las = 1,
            xlim = c(0,1), ylim = c(0,1), 
            xaxs = "i", yaxs = "i", 
            xaxp = c(0,1,2), yaxp = c(0,1,2), 
            xlab = "vegetation cover") 

rho <- seq(0,1,length = 100)

```

## non-spatial models

### logistic growth

If assuming phenomenological logistic growth, the gain in vegetation as a function of present vegetation cover is 

$$ G(V) = rV(1-\frac{V}{K}) \,,$$

with the growth rate, $r$, and the carrying capacity, $K$, decelerating the exponential growth as vegetation cover increases and reducing it to zero if $V \geq K$. Thus, it is a decelerating effect (a negative feed-back) at high vegetation cover. 

```{r, echo=FALSE}

G <- function(P, r = 2, K = 1) r*P*(1-P/K)

defplot(rho, G(rho), ylab = "growth")

```

#### mechanistic growth assumptions

In the first place the logistic growth model is phenomenological and does not provide a particular ecological explanation, why growth is decelerating to zero with increasing cover. It assumes just some form of global competition leading to a balance of gains and losses at the carrying capacity of the ecosystem. 

Mechanistic explanations can be the limitations by a globally diffuse resource, like water, or the occupation of space and the subsequent limitation of photosynthetic active surface. 

A multitude of such global feedback processes can define the precise shape of the growth function leading to asymetrical or truncated shapes, which could importantly affect the bistability properties of the system [@noy-meir75]. He defines

> The general shape of the growth function relating net growth to plant biomass, $G(V)$, is convex with a single maximum (Fig. 1). The increase in the low-biomass range expresses the increase in photosynthetic capacity with increasing leaf area. The levelling off to a plateau and the decrease in the higher range expresses self-interference effects (shading, competition); at the point $V = V_\mathrm{max}$ 'maintenance' losses equal photosynthesis and $G = 0$. Vmax is the maximum (stable) biomass in ungrazed vegetation. [...] Of the explicit forms the best known is the logistic [...] but other functions are possible.

We consider these multiple competitive effects being of minor relevance for now and start with a single limitation by the factor space. As the landscape becomes more and more filled with vegetation, the empty space become scarce. Thus, growth declines until each potentially habitable spot is occupied. We implement a generally valid carrying capacity, $K$. 


```{r, echo=FALSE}
G <- function(P, r = 2.25, K = 0.9) r*P*(1-P/K)

defplot(rho, G(rho), ylab = "growth")

```

**This model is going to be the starting point for the model development**

We assume that growth rate is linearly related to environmental quality, $b$, which is inverse to aridity. Since drylands are water limited in the first place, this factor defines the reproduction rate (i.e. number of seeds produced per plant, number of seedlings surviving the harshness of the dry soils). We assume that

$$ r = r_0 * b $$ 

to have a gradient of environmental harshness, $b$, reaching from 0 to 1. 
The model thus starts out with the assumption of decelerating growth due to competition for space. 

#### accelerating growth   

In arid ecosystems, growth rates would be lowest at very low cover and accelerate as cover increases, because retention of water and organic matter in the site is fundamentally reduced and water runoff is high. This postive feed-back (low cover reduces growth, leading to even lower cover) was discussed by @vandekoppel97 and @rietkerk97 to explain bistability in arid ecosystems.

Starting out from the logistic growth term, we now additionally assume that $r$ is accelerated with cover,

$$ r = r_0 b V^a $$

$$ G(V) = r_0 b V^{a+1} (1-\frac{V}{K}) \,,$$


```{r, echo=FALSE}


r <- function(P, r_0 =  2.25, a = 1) r_0 *P^a

#defplot(rho, r(rho), ylab = "growth")

G_sig <- function(P, r_0 = 2.25, a = 1,  K = 0.9) r(P, r_0, a)*P*(1-P/K)

defplot(rho, G_sig(rho), ylab = "growth")
lines(rho, G_sig(rho, a = 0))
lines(rho, G_sig(rho,r_0 = 2.25, a = 1))
lines(rho, G_sig(rho,r_0 = 2.25, a = 0.2))
```

### plant mortality

#### linear plant mortality

In the cellular automata model and mean-field approximations of @kefi07, individual plant mortality is a constant rate, which means it is increasing linearly with vegetation cover. Total plant mortality due to grazing therefore would be described as

$$ C(V) = gVL \,, $$

with the grazing mortality, $g$, per grazer individual multiplied by livestock density, $L$. That is to say, per individual, a constant percentage of cover is eaten. That is, ecologically speaking, not realistic. 


```{r, echo=FALSE}
C <- function(V, L = 10, g = 0.01) (g*V*L)

defplot(rho, C(rho), ylab = "plant mortality")

```

#### constant plant mortality

In fact, when assuming a constant density of herbivores, grazing mortality will certainly saturate at some point, due to limitations of the herbivores handling times. A very parsimonious model would assume that grazing always is defined by this limitation of handling times, even at very low densities. 

Mortality due to grazing,

$$ C(V) = gL \,, $$

thus could be defined as constant, $g$, per grazer individual regardless of the vegetation cover.


```{r, echo=FALSE}
C <- function(V, L = 10, g = 0.01) g * L + V*0

defplot(rho, C(rho), ylab = "plant mortality")

```

Note that grazing mortality can exceed 1, meaning that grazers would exploit more biomass than provided at full cover. Thus stability can be only reached if growth is sufficiently higher and the landscape regenerates itself multiple times per year. 

#### type 2 functional response

In natural systems, however, consumption is defined by saturating functional responses, i.e. at low cover, density dependent mortality defined by search efficiency dominates, but at high cover handling times of the consumer will limit its intake rates. Therefore, plant mortality due to grazing should be 

$$ C(V) = \frac{aVL}{1+ahV} \,,$$

with the handling time, $h$ [time per landscape unit], and the search efficiency, $a$ [percent of landscape foraged in per time]. 

```{r, echo=FALSE}
C <- function(V, L = 10, a = 0.6, h = 100) (a*V*L)/(1+a*h*V)

defplot(rho, C(rho), ylab = "plant mortality")

```

Since we are calculating in fractions of landscape, i.e. vegetation cover, and not in cells, the handling time defines the time a grazer individual would need to handle the entire landscape as readily available fodder. The search time is the percentage of the landscape foraged in over the course of one year.  


#### type 3 functional response

The 

$$ C(V) = \frac{bV^{1+q}}{1+bhV^{1+q}} $$


```{r, echo=FALSE}
C <- function(V, L = 10, a = 0.6, h = 100, q = 1) (a*V^(1+q)*L)/(1+a*h*(V^(1+q)) ) 

defplot(rho, C(rho), ylab = "plant mortality")

```

#### null model

We assume the classic type II functional response plus an intrinsic mortality rate, 

$$ C(V) = m*V + \frac{aVL}{1+ahV} \,,$$


```{r, echo=FALSE}

C <- function(V, m_0 = 0.05, L = 10, a = 0.6, h = 100, q = 0) (m_0 * V) +(a*V^(1+q)*L)/(1+a*h*(V^(1+q)) ) 

defplot(rho, C(rho), ylab = "plant mortality")
abline(a = 0, b = 0.05, lty = 2)
```

**This model is going to be the starting point for our model development**


### bistability

Plotting the growth rate against the different mortality rates shows how the definition of grazing mortality alters our prediction of the steady states of the system. 

Compared to the more realistic non-linear functions, the constant grazing mortality assumption seems to predict both the attractor of the vegetated state and the tipping point much better than the density dependent mortality used in Kéfi et al 2007 TPB. In fact, the linear density dependent mortality does not predict bistability at all, given a simple logistic growth function. 


```{r, echo=FALSE}

defplot(rho, G(rho), ylab = "growth", col = "green3")
lines(rho, C(rho, L = 10, a = 0.01, h = 0.00001))
lines(rho, C(rho, L = 25, a = 0.01, h = 0.00001))
lines(rho, C(rho, L = 50, a = 0.01, h = 0.00001))
abline( h = 0.1 )
abline( h = 0.25 )
abline( h = 0.5 )
```


When assuming a type II functional response, the system gains true bistability. 

```{r, echo=FALSE}

defplot(rho, G(rho), ylab = "growth", col = "green3")
lines(rho, C(rho, L = 10))
lines(rho, C(rho, L = 25))
lines(rho, C(rho, L = 50))

```


The type 3 functional response finally predicts the existance of a stable degraded state that is not a desert, i.e. not entirely unvegetated. 

```{r, echo=FALSE}

defplot(rho, G(rho), ylab = "growth", col = "green3")
lines(rho, C(rho, L = 10, q = 1))
lines(rho, C(rho, L = 25, q = 1))
lines(rho, C(rho, L = 50, q = 1))

```

### population dynamics

The differential equation describing population cover above with $V$ and $C$ substituted would then become  

$$ \frac{\mathrm{d}\rho_1}{\mathrm{d}t} = r b V (1-\frac{V}{K}) - m V - \frac{aVL}{1+ahV} $$

Given a parameter set  
```{r, echo=FALSE}

parms <- list(
    m = 0.05,
    r = 1,
    b = 0.9, 
    K = 0.9, 
    a = 0.6,
    h = 100,
    L = 10
  )

 as.data.frame(parms)
```
we receive a projection of the intersection of growth and mortality.

```{r, echo=FALSE}
plot(rho,  with(parms,  m * rho + (a * rho * L)/(1 + a * h * rho)), ylab = "growth", type = "l", ylim = c(0,0.5))
lines(rho, with(parms, r* b* rho * (1 - rho/K) ), col = "green3" )

```

And solving the ODE, starting with values larger than the unstable equilibrium point on the left,  returns a timeseries 

```{r, echo=FALSE}
d_rho <- function(rho, parms, z = 4) { 
  with(parms, r* b* rho * (1 - rho/K) - m * rho - (a * rho * L)/(1 + a * h * rho) )  
}


odesys <- function (t, rho, parms = model_parms) {
  list( d_rho(rho, parms)  )
}

library(deSolve)
# running the ode-solver
runmodel <- ode(y = 0.90, func = odesys, times = 1.1^(1:53), parms = parms)

# transfer into ouput and calculate missing rho values
ODEnullmodel <- as.data.frame(runmodel)


plot(ODEnullmodel, type = "l", ylim = c(0,1))

```

### Cellular Automata

The differential equations are formulated as changes in vegetation cover. Growth are positive changes, and deaths are negative changes.

Now, the CA uses transition probabilities. That is, a) the individual risk of death of vegetated cells and b) the individual chance of becoming vegetated for an empty cell.
To translate into the CA context, we need to find rules that apply to a) the vegetated cells, and b) the empty cells. Thus, it would be a) the reduction of term of the population of vegetated cells, divided by cover, to get the individual risk of death

$$ w_{1,0} = m + \frac{aL}{1+ah\rho_1} $$


This would be b) the growth term for the population of empty cells, divided by cover of empty cells, to get the individual chance of growth.

$$ w_{0,1} = \frac{r \rho_1 b (1-\frac{\rho_1}{K})}{1-\rho_1} $$
 

From an individual cell perspective, the probabilities would change along with cover like this

```{r, echo=FALSE}
par(mar = c(4,4,2,4))
plot(rho,  with(parms,  r * b *  ( 1 - (rho / K)) / (1 - rho) ) , ylab = "individual growth on empty cells", type = "l", ylim = c(0,2.5), las = 1, yaxs = "i")

lines(rho, with(parms, m + ( a * L )/( 1 + a * h * rho ) ), col = "red3" )
axis(4, las = 1)
mtext("individual risk of death of vegetated cells", 4, 3)
```

Running this in a timeseries of 150 years yields

```{r, echo = FALSE}

source("../code/simfunctions.r")

set.seed(584232) # setting seed for random number generation

nullmodel <- runCA(0.9, parms, delta = 0.2, t_max = 150, t_min = 100, t_eval = 50, isstable = 0.0001, saveeach = 5)


plot(nullmodel$rho_one ~ nullmodel$time, 
     ylim = c(0,1), ylab = expression( rho["+"]), 
     xlab = "time [yr]", type = "l")
     

lines(ODEnullmodel, lty = 3)

#animateCA(nullmodel, "ca_nullmodel.gif")


```


## spatially-explicit models

The models described above were discussed by @noy-meir75 for grazing systems where vegetation is assumed to be of homogeneous distribution, and no spatially-explicit effects are of relevance. 
Refugia or fencing of areas, however, could be considered as spatial effects. 

In arid and semi-arid rangelands, spatial vegetation structure was considered to be of major importance for plant growth and mortality [@rietkerk97; @kefi07]. It generates patterns that act as positive feed-backs on the local scale by providing refugia to grazing and overcome growth limitations at low vegetation cover.

These mechanisms can be implemented in the model by using a pair-approximation approach. 
In numerical simulations $G$ and $C$ can be implemented as the transition rates in a two-state spatial model. 

In the formalism of the pair-approximation model of @kefi07, growth, *i.e.* the total amount of empty cells transitioning into vegetated cells, becomes a complex function of the relative cover of the multiple pairs including a $+$.

In a model with only global effects, the transition probability of indiviual plant death would be

$$ w_{1,0} = C(V)/V = m + \frac{aL}{1+ahV} $$

and the transition probability of individual plant growth

$$ w_{0,1} = G(V)/V = r (1-\frac{V}{K}) \,.$$

### spatially-explicit growth
  
We implement accelerating and decelerating features on growth and mortality on the local level.

#### accelerating growth

This is assuming that the local environmental suitability is enhanced by a local facilitation term similar to the implementation in Kéfi et al 2007. Thus, the growth rate becomes a function of local vegetation cover $\nu$:

$$ r = r_0 + f \nu \,,$$

with an intrinsic growth rate $r_0$ which determines the probability of growth in absence of local vegetation and the additive facilitation $f$ which gradually determines the enhancement of the growth with an increasing local vegetation cover (maximizing at $\nu = 1$ if the cell has 4 neighbors). 

#### decelerating growth

For instance, if plant cover would have a dominantly negative effect on it's surroundings, by depleting nutrients or light, the local neighborhood of a plant cannot be occupied as easy as more remote places. As cover increases and the interspace areas are closing in, the space available for rejuvenation approaches zero. 
This is assuming that growth is diminished locally by competition, $c$. This affects carrying capacity rather than growth rate itself.

$$ K = K_0 (1 - c \nu)$$


### spatially-explicit mortality

On the mortality side, we can implement spatially explicit effects on the parameters of the functional response. 

#### accelerating mortality

Mortality becomes enhanced in sparse environments by patches that are attracting grazers. We assume this attractivity, $v$, reduces search times locally. 

$$ a = a_0 * (1 - v * \nu) $$

#### decelerating mortality

Plants in grazed habitats develop protective traits, such as thorns or cushion growth. They thereby provide protected habitat to their direct neighborhood, or share the investments in those traits with their neighbors. Overall grazing mortality thus is reduced through an increase in handling time by associational resistance, $p$

$$ h = h_0 * p * \nu $$


### implementation in a cellular automaton

It is straigthforward to implement the model in a cellular automata model. It is defined on a defined grid of cells where each cell can take the values '1' if it is vegetated and '0' if it is empty. The transition rules between those states depend either on global vegetation cover $\rho_1$ or on the local cover in the direct neighborhood of the cell $\nu_1$ (closest 4 cells, von-Neumann-neighborhood). 

Thus, two transition probabilities need to be defined: the probability of **growth**, $w_{0,1}$, turning an empty cell into a vegetated, and the probability of **death**, $w_{0,1}$, removing vegetation from the cell.

The null model, i.e. the model with only global effects on mortality and growth, with the basic assumption of a type II functional response and logistic growth, would thus be defined by

$$ w_{0,1} = r (1-\frac{\rho_1}{K})$$

$$ w_{1,0} =  m + \frac{aL}{1+ah\rho_1} $$


### implementation in a pair-approximation model

The pair-approximation framework (Matsuda et al 1992) is defined as a system of ordinary differential equations, describing the populations of *pairs* of cells. In a two state system, three pairs can be defined with population densities $\rho_{1,1}$ , $\rho_{0,0}$, and $\rho_{0,1}$. Besides, there are the population densities of singletons, $\rho_0$ and $\rho_1$. 

There are conservation equations which allow to calculate population densities of one pair out of the other pairs and singletons.

$$ \rho_1 + \rho_0 = 1$$

$$ \rho_{1,1} + \rho_{0,1} = \rho_1$$

$$ \rho_{0,1} + \rho_{0,0} = \rho_0$$

This means, the system can be fully described by two differential equations: 

$$ \frac{\mathrm{d}\rho_{1}}{\mathrm{d}t} = $$

$$ \frac{\mathrm{d}\rho_0}{\mathrm{d}t} = $$






# References